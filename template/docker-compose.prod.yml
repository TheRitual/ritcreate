services:
  postgres:
    image: postgres:16.4-alpine
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-{{REPO_NAME_SNAKE}}}
    networks:
      - backend-db
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 5s
      timeout: 5s
      retries: 5

  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    image: {{REPO_NAME}}-api:latest
    environment:
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/{{REPO_NAME_SNAKE}}}
      PORT: 4000
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@example.com}
      GRPC_HEALTH_PORT: ${GRPC_HEALTH_PORT:-50051}
      GRPC_HELLO_PORT: ${GRPC_HELLO_PORT:-50052}
    networks:
      - backend-db
      - frontend-backend
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://127.0.0.1:4000/health', (r) => { r.resume(); process.exit(r.statusCode === 200 ? 0 : 1); }).on('error', () => process.exit(1));\""]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL:-/api}
        VITE_GRPC_WEB_URL: ${VITE_GRPC_WEB_URL:-}
    image: {{REPO_NAME}}-web:latest
    environment:
      NODE_ENV: production
      PORT: 3000
      API_UPSTREAM: ${API_UPSTREAM:-http://api:4000}
      ENVOY_GRPC_WEB_UPSTREAM: ${ENVOY_GRPC_WEB_UPSTREAM:-http://envoy-grpc-web:8080}
    networks:
      - frontend-backend
    depends_on:
      api:
        condition: service_healthy
    ports:
      - "${WEB_PORT:-8080}:3000"

  envoy-grpc-web:
    image: envoyproxy/envoy:v1.31-latest
    volumes:
      - ./docker/envoy-grpc-web.prod.yml:/etc/envoy/envoy.yaml:ro
    command: ["-c", "/etc/envoy/envoy.yaml", "-l", "info"]
    networks:
      - frontend-backend
    depends_on:
      - api

networks:
  backend-db:
    driver: bridge
  frontend-backend:
    driver: bridge
